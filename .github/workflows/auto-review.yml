name: Auto Review PR with ChatGPT

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt

      - name: Call ChatGPT API
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PROMPT="Please review the following code diff and provide constructive feedback:\n\n$(cat diff.txt)"
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o",
              "messages": [{"role": "user", "content": "'"$PROMPT"'"}]
            }' | jq -r '.choices[0].message.content')
          echo "$RESPONSE" > review.txt

      - name: Post review to PR
        uses: mshick/add-pr-comment@v2
        with:
          message-path: review.txt
